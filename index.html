<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolutionary Adaptation Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Fredoka', sans-serif; background-color: #f8fafc; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .trait-card { transition: all 0.2s ease; }
        .trait-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .trait-card.selected { border-color: #22c55e; background-color: #f0fdf4; box-shadow: 0 0 0 2px #22c55e; }
        .trait-card .check-icon { display: none; }
        .trait-card.selected .check-icon { display: block; }
        .stat-bar-fill { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .creature-base { transition: all 0.5s ease-in-out; position: relative; z-index: 10; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .floating { animation: float 4s ease-in-out infinite; }
        @keyframes bounce-happy { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .happy-bounce { animation: bounce-happy 1.5s infinite ease-in-out; }
        .accessory-icon { position: absolute; display: flex; align-items: center; justify-content: center; transform-origin: center; pointer-events: none; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .dead-creature { filter: grayscale(100%) brightness(70%); transform: rotate(180deg); opacity: 0.8; }
        .offspring-container { opacity: 0.9; filter: brightness(1.1); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #86efac; border-radius: 4px; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col bg-slate-50">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-xl sticky top-0 z-50 border-b-4 border-green-500">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-green-500 p-2 rounded-lg shadow-lg shadow-green-500/20">
                    <i class="fa-solid fa-dna text-2xl text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">Nature's Adapter</h1>
                    <!-- UPDATED HEADER TEXT -->
                    <p class="text-xs text-slate-400 font-normal">3.3 adaptation and habitat</p>
                </div>
            </div>
            <div id="points-display" class="hidden bg-slate-800 border border-slate-700 px-5 py-2 rounded-full font-bold flex items-center gap-3 shadow-inner">
                <span class="text-slate-400 text-sm uppercase tracking-wider">DNA Points</span>
                <span id="current-points" class="text-green-400 text-2xl font-black">40</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-6 max-w-6xl mx-auto w-full">
        
        <!-- View 1: Scenario Selection -->
        <div id="view-selection" class="animate-pop block py-8">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-black text-slate-800 mb-4">Select an Environment</h2>
                <p class="text-slate-500 text-lg max-w-2xl mx-auto">Choose a subject to evolve. You will need to select the correct physical traits to ensure the organism survives the harsh conditions.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards generated by JS -->
            </div>
        </div>

        <!-- View 2: Evolution Lab -->
        <div id="view-lab" class="hidden animate-pop h-full flex flex-col">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-6 flex flex-col md:flex-row gap-6 items-center">
                 <div class="flex-grow">
                    <h3 id="env-title" class="text-2xl font-bold text-slate-800 mb-2">Environment Title</h3>
                    <p id="env-desc" class="text-slate-600 mb-4 text-sm"></p>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                        <div class="flex items-center gap-2 mb-2 text-red-800 font-bold border-b border-red-200 pb-2">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            <h4>Harsh Environmental Conditions</h4>
                        </div>
                        <div id="env-conditions-table" class="text-sm"></div>
                    </div>
                 </div>
                 <button onclick="calculateResults()" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-green-600/20 transition-all transform hover:scale-105 flex items-center justify-center gap-2 text-lg group">
                    Test Survival <i class="fa-solid fa-flask group-hover:rotate-12 transition-transform"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                <div class="lg:col-span-4 order-2 lg:order-1 flex flex-col gap-4">
                    <h3 class="font-bold text-slate-500 uppercase text-xs tracking-wider flex justify-between items-center">
                        <span>Adaptations</span>
                        <span class="text-[10px] bg-slate-200 px-2 py-1 rounded">Scroll for more</span>
                    </h3>
                    <div id="traits-grid" class="grid grid-cols-1 gap-3 max-h-[600px] overflow-y-auto pr-2 pb-4"></div>
                </div>

                <div class="lg:col-span-5 order-1 lg:order-2">
                    <div class="sticky top-24">
                        <div class="relative w-full aspect-square rounded-3xl overflow-hidden shadow-2xl border-4 border-white bg-slate-900 group">
                            <img id="stage-bg" src="" class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110 opacity-80" alt="Habitat">
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-transparent to-transparent"></div>
                            <div class="absolute inset-0 flex items-center justify-center z-10">
                                <div id="creature-container" class="relative w-64 h-64 flex items-center justify-center floating transition-all duration-500"></div>
                            </div>
                            <div class="absolute bottom-6 left-6 right-6 z-30">
                                <div class="text-white text-xs font-bold uppercase tracking-wider mb-1 opacity-70">Evolution Progress</div>
                                <div class="h-1.5 w-full bg-slate-700 rounded-full overflow-hidden mb-2">
                                    <div id="evolution-progress" class="h-full bg-green-400 transition-all duration-500 w-0"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-3 order-3 lg:order-3">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 sticky top-24">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2 border-b pb-4">
                            <i class="fa-solid fa-chart-pie text-2xl text-blue-500"></i> Vital Statistics
                        </h3>
                        <div id="stats-bars-container" class="space-y-6">
                            <div class="group">
                                <div class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                                    <span class="flex items-center gap-1"><i class="fa-solid fa-khanda text-red-500"></i> ATTACK</span>
                                    <span id="val-atk" class="bg-slate-100 px-2 rounded text-slate-700">0</span>
                                </div>
                                <div class="h-3 bg-slate-100 rounded-full overflow-hidden relative">
                                    <div class="absolute left-0 top-0 bottom-0 border-r border-white/50 z-10 w-[20%]"></div>
                                    <div id="bar-atk" class="h-full bg-gradient-to-r from-red-400 to-red-600 stat-bar-fill w-0 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
                                </div>
                            </div>
                            <div class="group">
                                <div class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                                    <span class="flex items-center gap-1"><i class="fa-solid fa-shield-halved text-blue-500"></i> DEFENSE</span>
                                    <span id="val-def" class="bg-slate-100 px-2 rounded text-slate-700">0</span>
                                </div>
                                <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                                    <div id="bar-def" class="h-full bg-gradient-to-r from-blue-400 to-blue-600 stat-bar-fill w-0 shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                                </div>
                            </div>
                            <div class="group">
                                <div class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                                    <span class="flex items-center gap-1"><i class="fa-solid fa-heart-pulse text-green-500"></i> SURVIVAL</span>
                                    <span id="val-sur" class="bg-slate-100 px-2 rounded text-slate-700">0</span>
                                </div>
                                <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                                    <div id="bar-sur" class="h-full bg-gradient-to-r from-green-400 to-green-600 stat-bar-fill w-0 shadow-[0_0_10px_rgba(34,197,94,0.5)]"></div>
                                </div>
                            </div>
                            <div class="group">
                                <div class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                                    <span class="flex items-center gap-1"><i class="fa-solid fa-wind text-yellow-500"></i> EVASION</span>
                                    <span id="val-eva" class="bg-slate-100 px-2 rounded text-slate-700">0</span>
                                </div>
                                <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                                    <div id="bar-eva" class="h-full bg-gradient-to-r from-yellow-400 to-yellow-600 stat-bar-fill w-0 shadow-[0_0_10px_rgba(234,179,8,0.5)]"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t text-xs text-slate-400 leading-tight">
                            Tip: You have 40 points. You MUST match specific traits to critical problems.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View 3: Results -->
        <div id="view-result" class="hidden animate-pop max-w-6xl mx-auto w-full py-12 px-4">
            
            <div class="space-y-8">
                <!-- 1. Environmental Context Card -->
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
                    <div class="bg-slate-800 px-8 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <span class="bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span> 
                            Environmental Context
                        </h2>
                    </div>
                    <div class="p-8">
                        <h3 id="res-env-title" class="text-3xl font-black text-slate-800 mb-2">Environment Title</h3>
                        <p id="res-env-desc" class="text-slate-600 mb-6 text-lg">...</p>
                        
                        <div class="bg-red-50 rounded-xl p-6 border border-red-100">
                            <h4 class="font-bold text-red-800 mb-4 uppercase text-xs tracking-wider border-b border-red-200 pb-2">Challenges Identified</h4>
                            <div id="res-env-challenges" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- JS Injected Challenges -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Organism Design Card -->
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
                    <div class="bg-slate-800 px-8 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <span class="bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span> 
                            Your Design Configuration
                        </h2>
                    </div>
                    <div class="p-8">
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <!-- Visual (4 cols) -->
                            <div class="lg:col-span-4 flex flex-col gap-6">
                                <div id="result-creature-stage" class="relative h-64 w-full bg-slate-50 rounded-2xl border-2 border-slate-100 flex justify-center items-center overflow-hidden shadow-inner bg-gradient-to-b from-slate-50 to-slate-100">
                                    <!-- Creature -->
                                </div>
                                <div class="bg-white border border-slate-200 rounded-2xl p-6">
                                    <h3 class="font-bold text-slate-700 mb-4 uppercase text-xs tracking-wider">Final Statistics</h3>
                                    <div id="result-stats-clone"></div>
                                </div>
                            </div>

                            <!-- Traits (8 cols) -->
                            <div class="lg:col-span-8">
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-dna text-blue-600"></i> All Available Adaptations
                                </h3>
                                <div id="result-traits-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[500px] overflow-y-auto pr-2">
                                    <!-- JS Injected Traits -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Survival Analysis & Verdict -->
                <div class="bg-slate-900 rounded-3xl shadow-2xl overflow-hidden border border-slate-800 text-white">
                    <div class="px-8 py-6 border-b border-slate-700 flex justify-between items-center">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <span class="bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center text-sm">3</span> 
                            Survival Analysis Report
                        </h2>
                        <div id="final-score-badge" class="bg-slate-700 px-4 py-1 rounded-full text-sm font-bold text-green-400 border border-slate-600">
                            Score: 0%
                        </div>
                    </div>
                    
                    <div class="p-8">
                        <!-- Analysis Table -->
                        <div class="bg-slate-800 rounded-xl overflow-hidden mb-8 border border-slate-700">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-700 text-slate-400 uppercase font-bold text-xs">
                                    <tr>
                                        <th class="px-6 py-4 w-1/4">Harsh Condition</th>
                                        <th class="px-6 py-4 w-1/4">Survival Outcome</th>
                                        <th class="px-6 py-4 w-1/2">Contributing Adaptations</th>
                                    </tr>
                                </thead>
                                <tbody id="result-conditions-table-body" class="divide-y divide-slate-700 text-slate-200">
                                    <!-- JS Injected Rows -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Final Verdict -->
                        <div class="text-center pt-4">
                            <div class="inline-block bg-slate-800 rounded-full px-4 py-1 text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 border border-slate-700">Evolutionary Result</div>
                            <h3 id="result-title" class="text-5xl font-black mb-4 bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">Result Title</h3>
                            <p id="result-feedback" class="text-xl text-slate-400 max-w-2xl mx-auto font-light leading-relaxed">...</p>
                            
                            <div class="mt-10">
                                <button onclick="resetLab()" class="bg-white hover:bg-slate-100 text-slate-900 font-bold py-3 px-8 rounded-xl shadow-lg transition-all transform hover:scale-105 active:scale-95">
                                    Test Another Environment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- JavaScript Logic -->
    <script>
        const scenarios = [
            {
                id: 'fish',
                name: 'Deep Sea Fish',
                icon: 'fa-fish',
                baseIcon: 'fa-fish',
                color: 'bg-indigo-50 border-indigo-200 text-indigo-900',
                envTitle: 'The Abyssal Zone',
                envDesc: 'An eternal void of crushing pressure (800 atm) where freezing temperatures halt life processes and food is non-existent.',
                bgUrl: 'https://i.ibb.co/6cDmgv41/2019-07t062706-edited.jpg',
                challenges: [
                    { name: "Crushing Pressure", requiredTrait: "Gelatinous Body", stats: ["sur"], min: 35, critical: true, desc: "800 atm pressure. Needs specific structural adaptation." },
                    { name: "Freezing Cold", requiredTrait: "Antifreeze Blood", stats: ["sur"], min: 20, critical: true, desc: "Near freezing temp (2째C). Needs chemical protection." },
                    { name: "Pitch Blackness", requiredTrait: ["Bioluminescence", "Giant Eyes", "Sensitive Lateral Line"], stats: ["atk", "sur"], min: 15, critical: false, desc: "Zero sunlight. Needs own light source or enhanced senses." },
                    { name: "Food Scarcity", requiredTrait: ["Slow Metabolism", "Needle Teeth", "Distensible Stomach"], stats: ["atk", "sur"], min: 30, critical: false, desc: "Rare prey. Needs energy conservation or efficient feeding." },
                    { name: "Predators", requiredTrait: ["Spiky Scales", "Transparent Skin", "Needle Teeth"], stats: ["def", "eva"], min: 20, critical: false, desc: "Silent hunters. Needs physical defense, camouflage or counter-attack." },
                    { name: "Low Oxygen", requiredTrait: "Hyper-Efficient Gills", stats: ["sur"], min: 25, critical: false, desc: "Low dissolved oxygen. Needs better respiration." }
                ], 
                traits: [
                    { name: 'Bioluminescence', cost: 5, stats: { atk: 10, sur: 5, eva: 0, def: 0 }, desc: 'Produces own light to attract meals in absolute darkness.', visual: { type: 'filter', val: 'drop-shadow(0 0 30px #facc15)' } },
                    { name: 'Gelatinous Body', cost: 10, stats: { atk: 0, sur: 40, eva: 5, def: -5 }, desc: 'Soft, fluid structure equilibrates with external forces to prevent being crushed.', visual: { type: 'layer', color: 'text-pink-200', opacity: 0.3, scale: 1.3, filter: 'blur(3px)' } },
                    { name: 'Antifreeze Blood', cost: 6, stats: { atk: 0, sur: 25, eva: 0, def: 0 }, desc: 'Special proteins stop ice crystals from growing in near-zero temperatures.', visual: { type: 'attachment', icon: 'fa-snowflake', color: 'text-cyan-300', top: '40%', left: '50%', size: '3rem', rotate: '0deg' } },
                    { name: 'Needle Teeth', cost: 8, stats: { atk: 30, sur: 0, eva: 0, def: 0 }, desc: 'Long, sharp spikes ensure slippery prey cannot escape once caught.', visual: [{ type: 'attachment', icon: 'fa-caret-up', color: 'text-white', top: '65%', left: '5%', size: '2rem', rotate: '-10deg' }, { type: 'attachment', icon: 'fa-caret-up', color: 'text-white', top: '66%', left: '12%', size: '1.5rem', rotate: '5deg' }, { type: 'attachment', icon: 'fa-caret-up', color: 'text-white', top: '64%', left: '18%', size: '1.8rem', rotate: '15deg' }] },
                    { name: 'Giant Eyes', cost: 6, stats: { atk: 5, sur: 5, eva: 15, def: 0 }, desc: 'Maximizes capture of the faintest photons in a lightless environment.', visual: { type: 'attachment', icon: 'fa-eye', color: 'text-yellow-200', top: '20%', left: '15%', size: '3.5rem', rotate: '-10deg' } },
                    { name: 'Slow Metabolism', cost: 7, stats: { atk: 0, sur: 25, eva: -5, def: 0 }, desc: 'Drastically reduces energy needs when meals are weeks apart.', visual: [{ type: 'color', val: '#94a3b8' }, { type: 'attachment', icon: 'fa-bed', color: 'text-slate-400', top: '20%', left: '80%', size: '2rem', rotate: '0deg' }] }, 
                    { name: 'Spiky Scales', cost: 8, stats: { atk: 5, sur: 0, eva: -5, def: 25 }, desc: 'Physical barrier makes it painful for hunters to bite.', visual: { type: 'layer', color: 'text-slate-400', opacity: 0.6, scale: 1.15 } },
                    { name: 'Sensitive Lateral Line', cost: 5, stats: { atk: 0, sur: 5, eva: 20, def: 0 }, desc: 'Detects minute pressure waves from moving objects nearby.', visual: { type: 'attachment', icon: 'fa-wave-square', color: 'text-blue-300', top: '50%', left: '60%', size: '2rem', rotate: '0deg' } },
                    { name: 'Distensible Stomach', cost: 6, stats: { atk: 0, sur: 15, eva: -5, def: 0 }, desc: 'Allows swallowing massive meals to capitalize on rare feeding opportunities.', visual: { type: 'attachment', icon: 'fa-drumstick-bite', color: 'text-orange-300', top: '70%', left: '60%', size: '2rem', rotate: '-20deg' } },
                    { name: 'Transparent Skin', cost: 4, stats: { atk: 0, sur: 0, eva: 15, def: 0 }, desc: 'Renders the silhouette invisible against the water column.', visual: { type: 'filter', val: 'opacity(0.5)' } },
                    { name: 'Hyper-Efficient Gills', cost: 6, stats: { atk: 0, sur: 25, eva: 0, def: 0 }, desc: 'Extracts every molecule of dissolved gas from the water.', visual: { type: 'attachment', icon: 'fa-lungs', color: 'text-pink-400', top: '50%', left: '30%', size: '2rem', rotate: '90deg' } }
                ]
            },
            {
                id: 'amphibian',
                name: 'Swamp Amphibian',
                icon: 'fa-frog', 
                baseIcon: 'fa-frog', 
                color: 'bg-emerald-50 border-emerald-200 text-emerald-900',
                envTitle: 'Toxic Wetlands',
                envDesc: 'A sludge-filled bog choking on chemical runoff. The water evaporates rapidly, leaving behind acidic mud and deadly fungal spores.',
                bgUrl: 'https://i.ibb.co/Z1kw2WDt/louisiana-swamp.jpg', 
                challenges: [
                    { name: "Chemical Toxins", requiredTrait: "Mucus Coating", stats: ["sur"], min: 30, critical: true, desc: "High pollution levels. Skin needs direct protection." },
                    { name: "Drying Pools", requiredTrait: ["Estivation", "Extra Lungs"], stats: ["sur"], min: 20, critical: true, desc: "Water disappears for weeks. Needs dormancy or air breathing." },
                    { name: "Aerial Predators", requiredTrait: ["Camouflage", "Neurotoxin", "Powerful Legs", "Bright Warning Color"], stats: ["def", "eva"], min: 25, critical: false, desc: "Herons attack from above. Needs escape or defense." },
                    { name: "Insect Competition", requiredTrait: ["Sticky Tongue", "Powerful Legs"], stats: ["atk"], min: 20, critical: false, desc: "Too many frogs. Needs efficient hunting." },
                    { name: "Fungal Disease", requiredTrait: ["Antimicrobial Skin", "Mucus Coating"], stats: ["sur", "def"], min: 25, critical: false, desc: "Deadly skin fungus. Needs chemical barrier." },
                    { name: "Temperature Flux", requiredTrait: "Estivation", stats: ["sur"], min: 20, critical: false, desc: "Hot days, cold nights. Needs dormancy." }
                ],
                traits: [
                    { name: 'Mucus Coating', cost: 6, stats: { atk: 0, sur: 25, eva: 5, def: 5 }, desc: 'Creates a barrier against acidic pollutants and prevents skin drying.', visual: { type: 'filter', val: 'drop-shadow(0 0 10px #4ade80)' } },
                    { name: 'Bright Warning Color', cost: 5, stats: { atk: 0, sur: -5, eva: 0, def: 25 }, desc: 'Visual signal indicating toxicity to potential attackers.', visual: { type: 'color', val: '#facc15' } }, 
                    { name: 'Powerful Legs', cost: 7, stats: { atk: 5, sur: 0, eva: 30, def: 0 }, desc: 'Enables explosive movement to dodge attacks from above.', visual: { type: 'attachment', icon: 'fa-shoe-prints', color: 'text-green-800', top: '75%', left: '85%', size: '2.5rem', rotate: '-30deg' } },
                    { name: 'Neurotoxin', cost: 10, stats: { atk: 20, sur: 0, eva: 0, def: 20 }, desc: 'Secretes lethal chemicals to deter predation.', visual: { type: 'attachment', icon: 'fa-skull', color: 'text-purple-600', top: '20%', left: '80%', size: '3rem', rotate: '0deg' } },
                    { name: 'Extra Lungs', cost: 6, stats: { atk: 0, sur: 20, eva: 0, def: 0 }, desc: 'Allows oxygen intake directly from the atmosphere when water is poor.', visual: { type: 'attachment', icon: 'fa-lungs', color: 'text-pink-300', top: '50%', left: '90%', size: '2.5rem', rotate: '0deg' } },
                    { name: 'Camouflage', cost: 6, stats: { atk: 5, sur: 5, eva: 15, def: 0 }, desc: 'Skin patterns blend seamlessly with muddy surroundings.', visual: { type: 'color', val: '#3f6212' } },
                    { name: 'Regeneration', cost: 8, stats: { atk: 0, sur: 30, eva: 0, def: 0 }, desc: 'Rapidly heals or replaces tissues damaged by rot or injury.', visual: { type: 'attachment', icon: 'fa-plus', color: 'text-red-500', top: '40%', left: '10%', size: '2rem', rotate: '0deg' } },
                    { name: 'Sticky Tongue', cost: 5, stats: { atk: 15, sur: 0, eva: 0, def: 0 }, desc: 'Projectable capture mechanism for snatching fast-moving food.', visual: { type: 'attachment', icon: 'fa-bullseye', color: 'text-pink-500', top: '25%', left: '0%', size: '2rem', rotate: '0deg' } },
                    { name: 'Throat Sac', cost: 4, stats: { atk: 0, sur: 0, eva: 10, def: 5 }, desc: 'Amplifies calls to ensure communication amidst noise.', visual: { type: 'attachment', icon: 'fa-bullhorn', color: 'text-orange-400', top: '60%', left: '20%', size: '2rem', rotate: '-10deg' } },
                    { name: 'Antimicrobial Skin', cost: 7, stats: { atk: 0, sur: 25, eva: 0, def: 5 }, desc: 'Peptides neutralize harmful spores and bacteria on contact.', visual: { type: 'attachment', icon: 'fa-shield-virus', color: 'text-teal-400', top: '30%', left: '40%', size: '2rem', rotate: '0deg' } },
                    { name: 'Estivation', cost: 6, stats: { atk: 0, sur: 20, eva: 0, def: 0 }, desc: 'Enters a dormancy state to wait out heat and evaporation.', visual: { type: 'attachment', icon: 'fa-moon', color: 'text-green-300', top: '10%', left: '10%', size: '2rem', rotate: '0deg' } }
                ]
            },
            {
                id: 'mammal',
                name: 'Arctic Mammal',
                icon: 'fa-paw',
                baseIcon: 'fa-dog', 
                color: 'bg-slate-100 border-slate-200 text-slate-800',
                envTitle: 'Frozen Tundra',
                envDesc: 'A relentless white wasteland swept by 100km/h blizzards. Temperatures plummet to -60째C, and food is buried under meters of jagged ice.',
                bgUrl: 'https://i.ibb.co/RpN11Bwk/Arctic-1024x576.png', 
                challenges: [
                    { name: "Extreme Cold", requiredTrait: ["Thick Blubber", "Thick White Fur", "Compact Body"], stats: ["sur"], min: 40, critical: true, desc: "-60째C. Needs heavy insulation." },
                    { name: "Buried Food", requiredTrait: ["Sharp Claws", "Sensitive Whiskers", "Pack Hunting"], stats: ["atk"], min: 20, critical: true, desc: "Food is under 2m of ice. Must dig or hunt effectively." },
                    { name: "Severe Blizzards", requiredTrait: ["Hibernate", "Thick White Fur", "Compact Body"], stats: ["sur", "def"], min: 25, critical: false, desc: "Cannot hunt during storms. Needs shelter or endurance." },
                    { name: "Slippery Ice", requiredTrait: ["Wide Paws", "Sharp Claws"], stats: ["eva"], min: 20, critical: false, desc: "Zero traction. Needs grip." },
                    { name: "Seasonal Darkness", requiredTrait: ["Sensitive Whiskers", "Counter-Shading"], stats: ["sur", "atk"], min: 20, critical: false, desc: "3 months of night. Needs navigation." },
                    { name: "Lack of Shelter", requiredTrait: ["Thick White Fur", "Compact Body", "Hibernate"], stats: ["def", "sur"], min: 25, critical: false, desc: "No caves. Exposed to wind." }
                ],
                traits: [
                    { name: 'Thick White Fur', cost: 8, stats: { atk: 0, sur: 30, eva: 10, def: 5 }, desc: 'Traps body heat and blends with the snowy landscape.', visual: { type: 'color', val: '#f8fafc' } }, 
                    { name: 'Thick Blubber', cost: 8, stats: { atk: 0, sur: 35, eva: -5, def: 5 }, desc: 'Insulating fat layer that also serves as a fuel reserve.', visual: { type: 'scale', val: 1.2 } },
                    { name: 'Hibernate', cost: 7, stats: { atk: 0, sur: 25, eva: 0, def: 0 }, desc: 'Lowers metabolic rate to sleep through the harshest weather events.', visual: { type: 'attachment', icon: 'fa-bed', color: 'text-indigo-400', top: '15%', left: '80%', size: '2rem', rotate: '20deg' } },
                    { name: 'Sharp Claws', cost: 6, stats: { atk: 25, sur: 0, eva: 0, def: 0 }, desc: 'Tools for excavating through hard-packed snow and ice.', visual: { type: 'attachment', icon: 'fa-slash', color: 'text-slate-600', top: '80%', left: '10%', size: '3rem', rotate: '45deg' } },
                    { name: 'Small Ears', cost: 4, stats: { atk: 0, sur: 10, eva: 0, def: 0 }, desc: 'Reduces surface area to prevent frostbite and heat loss.', visual: { type: 'attachment', icon: 'fa-ear-deaf', color: 'text-slate-400', top: '20%', left: '10%', size: '1.2rem', rotate: '0deg' } },
                    { name: 'Pack Hunting', cost: 7, stats: { atk: 25, sur: 5, eva: 0, def: 0 }, desc: 'Cooperative strategy to take down larger prey.', visual: { type: 'attachment', icon: 'fa-users', color: 'text-orange-500', top: '40%', left: '85%', size: '2rem', rotate: '0deg' } },
                    { name: 'Nasal Heat Exchange', cost: 5, stats: { atk: 0, sur: 15, eva: 0, def: 0 }, desc: 'Warms freezing air before it reaches the core.', visual: { type: 'attachment', icon: 'fa-wind', color: 'text-blue-300', top: '35%', left: '5%', size: '1.5rem', rotate: '0deg' } },
                    { name: 'Wide Paws', cost: 5, stats: { atk: 0, sur: 0, eva: 20, def: 0 }, desc: 'Distributes weight to prevent sinking into deep drifts.', visual: { type: 'attachment', icon: 'fa-paw', color: 'text-slate-300', top: '90%', left: '50%', size: '2.5rem', rotate: '0deg' } },
                    { name: 'Counter-Shading', cost: 4, stats: { atk: 5, sur: 0, eva: 15, def: 0 }, desc: 'Visual disguise effective during the long polar night.', visual: { type: 'filter', val: 'brightness(1.1) contrast(0.9)' } },
                    { name: 'Sensitive Whiskers', cost: 5, stats: { atk: 10, sur: 0, eva: 10, def: 0 }, desc: 'Tactile sensors to navigate and hunt without light.', visual: { type: 'attachment', icon: 'fa-wifi', color: 'text-slate-500', top: '35%', left: '20%', size: '1.5rem', rotate: '90deg' } },
                    { name: 'Compact Body', cost: 6, stats: { atk: 0, sur: 25, eva: 0, def: 0 }, desc: 'Minimizes surface area to volume ratio to retain warmth.', visual: { type: 'scale', val: 0.8 } }
                ]
            },
            {
                id: 'reptile',
                name: 'Desert Reptile',
                icon: 'fa-dragon', 
                baseIcon: 'fa-dragon',
                color: 'bg-orange-50 border-orange-200 text-orange-900',
                envTitle: 'Scorching Dunes',
                envDesc: 'A furnace of shifting sands where surface temperatures boil water. There is no shade, no rain, and the sun bleaches bones in hours.',
                bgUrl: 'https://i.ibb.co/Ld7Kzs8z/DMG2210-3860flat-4.jpg', 
                challenges: [
                    { name: "Scorching Heat", requiredTrait: ["Burrowing Claws", "Reflective Scales"], stats: ["sur"], min: 30, critical: true, desc: "Surface is 50째C+. Must escape underground or reflect heat." },
                    { name: "Water Scarcity", requiredTrait: ["Water Tail", "Dew Collection", "Fat Reserves"], stats: ["sur"], min: 35, critical: true, desc: "No rain. Needs internal storage or collection." },
                    { name: "Predators", requiredTrait: ["Hard Scales", "Venom", "Shedding Tail", "Spiny Armor", "Sand Skin", "Burrowing Claws"], stats: ["def", "eva"], min: 25, critical: false, desc: "Hawks hunt from above. Needs defense or hiding." },
                    { name: "Loose Sand", requiredTrait: ["Sand Skin", "Burrowing Claws"], stats: ["eva"], min: 15, critical: false, desc: "Hard to walk. Needs adapted movement." },
                    { name: "UV Radiation", requiredTrait: ["Reflective Scales", "Hard Scales"], stats: ["def", "sur"], min: 20, critical: false, desc: "Direct sun burns skin." },
                    { name: "Freezing Nights", requiredTrait: ["Fat Reserves", "Burrowing Claws"], stats: ["sur"], min: 20, critical: false, desc: "Temp drops rapidly at night." }
                ],
                traits: [
                    { name: 'Hard Scales', cost: 6, stats: { atk: 0, sur: 10, eva: -5, def: 25 }, desc: 'Thick armor that shields against bites and intense solar rays.', visual: { type: 'layer', color: 'text-orange-800', opacity: 0.5, scale: 1.1 } },
                    { name: 'Burrowing Claws', cost: 6, stats: { atk: 5, sur: 10, eva: 15, def: 5 }, desc: 'Enables digging deep to find cooler earth underground.', visual: { type: 'attachment', icon: 'fa-paw', color: 'text-stone-600', top: '80%', left: '20%', size: '2rem', rotate: '0deg' } },
                    { name: 'Venom', cost: 8, stats: { atk: 35, sur: 0, eva: 0, def: 5 }, desc: 'Incapacitates prey instantly to minimize energy expenditure.', visual: { type: 'attachment', icon: 'fa-droplet', color: 'text-green-500', top: '20%', left: '10%', size: '2rem', rotate: '0deg' } },
                    { name: 'Water Tail', cost: 7, stats: { atk: 0, sur: 30, eva: -2, def: 0 }, desc: 'Specialized appendage for storing hydration reserves.', visual: { type: 'attachment', icon: 'fa-bottle-water', color: 'text-blue-400', top: '55%', left: '85%', size: '2.5rem', rotate: '-45deg' } }, 
                    { name: 'Sand Skin', cost: 5, stats: { atk: 5, sur: 0, eva: 15, def: 0 }, desc: 'Coloration mimics the shifting dunes for concealment, also allows for better movement on loose sand.', visual: { type: 'color', val: '#fdba74' } }, 
                    { name: 'Shedding Tail', cost: 5, stats: { atk: 0, sur: 5, eva: 20, def: 0 }, desc: 'Sacrificial limb to distract attackers during escape.', visual: { type: 'attachment', icon: 'fa-scissors', color: 'text-slate-500', top: '80%', left: '80%', size: '2rem', rotate: '0deg' } },
                    { name: 'Third Eyelid', cost: 4, stats: { atk: 0, sur: 10, eva: 5, def: 0 }, desc: 'Translucent membrane blocks grit while maintaining vision.', visual: { type: 'attachment', icon: 'fa-eye-slash', color: 'text-stone-400', top: '25%', left: '20%', size: '1.5rem', rotate: '0deg' } },
                    { name: 'Dew Collection', cost: 7, stats: { atk: 0, sur: 20, eva: 0, def: 0 }, desc: 'Skin texture channels morning condensation to the mouth.', visual: { type: 'attachment', icon: 'fa-glass-water', color: 'text-cyan-300', top: '40%', left: '50%', size: '2rem', rotate: '0deg' } },
                    { name: 'Spiny Armor', cost: 8, stats: { atk: 10, sur: 0, eva: -10, def: 30 }, desc: 'Sharp protrusions make the body difficult to swallow.', visual: { type: 'attachment', icon: 'fa-certificate', color: 'text-red-800', top: '50%', left: '50%', size: '4rem', rotate: '0deg' } },
                    { name: 'Reflective Scales', cost: 5, stats: { atk: 0, sur: 20, eva: 0, def: 10 }, desc: 'Shiny surfaces bounce back solar radiation.', visual: { type: 'filter', val: 'brightness(1.5)' } },
                    { name: 'Fat Reserves', cost: 6, stats: { atk: 0, sur: 25, eva: -5, def: 0 }, desc: 'Stored energy to maintain body heat when temperatures drop at night.', visual: { type: 'scale', val: 1.2 } }
                ]
            },
            {
                id: 'bird',
                name: 'Rainforest Bird',
                icon: 'fa-crow',
                baseIcon: 'fa-crow',
                color: 'bg-lime-50 border-lime-200 text-lime-900',
                envTitle: 'Dense Canopy',
                envDesc: 'A chaotic, suffocating labyrinth of leaves. Torrential downpours threaten hypothermia, and intense competition makes every meal a battle.',
                bgUrl: 'https://i.ibb.co/93sn5Bm8/indonesia-sulawesi-171331-2004x1336.jpg', 
                challenges: [
                    { name: "Cluttered Canopy", requiredTrait: ["Short Wings", "Zygodactyl Feet", "Binocular Vision"], stats: ["eva"], min: 35, critical: true, desc: "No space to flap long wings. Needs agility or climbing." },
                    { name: "Finding Mates", requiredTrait: ["Loud Call", "Bright Plumage", "Display Crest"], stats: ["sur", "atk"], min: 20, critical: true, desc: "Cannot see far. Needs sound or visual signal." },
                    { name: "Fierce Competition", requiredTrait: ["Mimicry", "Tool Use", "Grip Talons", "Loud Call"], stats: ["atk", "eva"], min: 30, critical: false, desc: "Too many animals. Needs competitive edge." },
                    { name: "Tough Food", requiredTrait: ["Hooked Beak", "Tool Use"], stats: ["atk"], min: 25, critical: false, desc: "Hard nuts/skins. Needs cracker or tool." },
                    { name: "Heavy Rainfall", requiredTrait: ["Oil Gland", "Grip Talons"], stats: ["sur", "def"], min: 20, critical: false, desc: "Hypothermia risk. Needs waterproofing." },
                    { name: "Parasites", requiredTrait: "Oil Gland", stats: ["sur", "def"], min: 20, critical: false, desc: "Mites destroy feathers. Needs chemical defense." }
                ],
                traits: [
                    { name: 'Short Wings', cost: 6, stats: { atk: 0, sur: 0, eva: 35, def: 0 }, desc: 'Compact shape allows tight turns between dense branches.', visual: { type: 'scale', val: 0.8 } }, 
                    { name: 'Hooked Beak', cost: 6, stats: { atk: 25, sur: 0, eva: 0, def: 0 }, desc: 'High leverage tool for cracking hard shells and skins.', visual: { type: 'attachment', icon: 'fa-chevron-left', color: 'text-orange-600', top: '20%', left: '10%', size: '3rem', rotate: '0deg' } },
                    { name: 'Loud Call', cost: 4, stats: { atk: 10, sur: 10, eva: 0, def: 0 }, desc: 'Acoustic signals capable of piercing through thick foliage.', visual: { type: 'attachment', icon: 'fa-volume-high', color: 'text-yellow-400', top: '50%', left: '10%', size: '2rem', rotate: '0deg' } },
                    { name: 'Grip Talons', cost: 6, stats: { atk: 10, sur: 5, eva: 15, def: 0 }, desc: 'Locking mechanism for stability on wet, vertical surfaces.', visual: { type: 'attachment', icon: 'fa-hand-lizard', color: 'text-amber-900', top: '85%', left: '20%', size: '2.5rem', rotate: '0deg' } },
                    { name: 'Bright Plumage', cost: 5, stats: { atk: 5, sur: 10, eva: 0, def: 0 }, desc: 'High-contrast colors visible in dappled light.', visual: { type: 'color', val: '#ef4444' } }, 
                    { name: 'Mimicry', cost: 7, stats: { atk: 0, sur: 15, eva: 10, def: 0 }, desc: 'Imitates dangerous species to deter rivals.', visual: { type: 'attachment', icon: 'fa-masks-theater', color: 'text-purple-500', top: '20%', left: '80%', size: '2.5rem', rotate: '0deg' } },
                    { name: 'Zygodactyl Feet', cost: 5, stats: { atk: 5, sur: 0, eva: 20, def: 0 }, desc: 'Toes arranged for climbing up vertical trunks.', visual: { type: 'attachment', icon: 'fa-hand-fist', color: 'text-amber-700', top: '90%', left: '50%', size: '2.5rem', rotate: '0deg' } },
                    { name: 'Binocular Vision', cost: 5, stats: { atk: 15, sur: 0, eva: 5, def: 0 }, desc: 'Overlapping visual fields to judge distance in 3D space.', visual: { type: 'attachment', icon: 'fa-glasses', color: 'text-blue-500', top: '25%', left: '25%', size: '2rem', rotate: '0deg' } },
                    { name: 'Tool Use', cost: 9, stats: { atk: 10, sur: 20, eva: 0, def: 0 }, desc: 'Ability to manipulate sticks to extract hidden food.', visual: { type: 'attachment', icon: 'fa-wrench', color: 'text-slate-600', top: '70%', left: '70%', size: '2rem', rotate: '0deg' } },
                    { name: 'Oil Gland', cost: 5, stats: { atk: 0, sur: 20, eva: 0, def: 5 }, desc: 'Secretes a chemical coating that waterproofs feathers and repels feather-destroying mites.', visual: { type: 'attachment', icon: 'fa-droplet', color: 'text-yellow-200', top: '60%', left: '70%', size: '2rem', rotate: '0deg' } },
                    { name: 'Display Crest', cost: 5, stats: { atk: 5, sur: 15, eva: 0, def: 0 }, desc: 'Physical ornamentation to stand out to potential partners.', visual: { type: 'attachment', icon: 'fa-crown', color: 'text-pink-500', top: '5%', left: '30%', size: '2.5rem', rotate: '-10deg' } }
                ]
            },
            {
                id: 'plant',
                name: 'Cliffside Plant',
                icon: 'fa-leaf',
                baseIcon: 'fa-leaf',
                color: 'bg-stone-50 border-stone-200 text-stone-800',
                envTitle: 'Windy Cliff',
                envDesc: 'A vertical nightmare of crumbling rock battered by hurricane-force gales. Salty ocean spray burns organic matter, and soil is non-existent.',
                bgUrl: 'https://i.ibb.co/5xKgmMv9/site-1505-0011-1200-630-20160616154958.jpg', 
                challenges: [
                    { name: "Hurricane Winds", requiredTrait: ["Flexible Stem", "Low Profile", "Deep Taproot"], stats: ["sur", "def"], min: 40, critical: true, desc: "100km/h wind snaps rigid plants. Needs to bend or hug ground." },
                    { name: "Rocky Soil", requiredTrait: ["Deep Taproot", "Root Network"], stats: ["sur"], min: 30, critical: true, desc: "No dirt. Needs to drill into rock." },
                    { name: "Salt Spray", requiredTrait: ["Waxy Cuticle", "Hairy Leaves", "Succulent Leaves"], stats: ["sur"], min: 25, critical: false, desc: "Ocean spray burns leaves. Needs coating." },
                    { name: "Hungry Goats", requiredTrait: ["Thorns", "Bitter Sap"], stats: ["def", "atk"], min: 15, critical: false, desc: "Climbers eat everything. Needs defense." },
                    { name: "Soil Erosion", requiredTrait: ["Root Network", "Deep Taproot"], stats: ["sur"], min: 20, critical: false, desc: "Rain washes dirt away. Needs anchors." },
                    { name: "Intense Sun", requiredTrait: ["Silver Hairs", "Hairy Leaves", "Waxy Cuticle"], stats: ["sur", "def"], min: 25, critical: false, desc: "Rock reflects heat. Needs reflection." }
                ],
                traits: [
                    { name: 'Deep Taproot', cost: 7, stats: { atk: 0, sur: 35, eva: 0, def: 10 }, desc: 'Penetrates cracks to secure the organism against gales.', visual: { type: 'attachment', icon: 'fa-arrow-down-long', color: 'text-stone-800', top: '90%', left: '50%', size: '4rem', rotate: '0deg' } },
                    { name: 'Flexible Stem', cost: 6, stats: { atk: 0, sur: 20, eva: 20, def: 10 }, desc: 'Pliable structure bends with airflow rather than snapping.', visual: { type: 'filter', val: 'skewX(15deg)' } }, 
                    { name: 'Waxy Cuticle', cost: 5, stats: { atk: 0, sur: 20, eva: 0, def: 5 }, desc: 'Impermeable layer prevents drying from saline mist.', visual: { type: 'color', val: '#10b981' } }, 
                    { name: 'Low Profile', cost: 5, stats: { atk: 0, sur: 15, eva: 15, def: 0 }, desc: 'Grows horizontally to avoid the strongest wind shear.', visual: { type: 'scale', val: 0.6 } }, 
                    { name: 'Thorns', cost: 4, stats: { atk: 15, sur: 5, eva: 0, def: 15 }, desc: 'Sharp defenses to ward off climbing herbivores.', visual: { type: 'attachment', icon: 'fa-asterisk', color: 'text-red-700', top: '50%', left: '85%', size: '2rem', rotate: '0deg' } },
                    { name: 'Airborne Seeds', cost: 5, stats: { atk: 0, sur: 15, eva: 20, def: 0 }, desc: 'Lightweight offspring dispersal utilizing air currents.', visual: { type: 'attachment', icon: 'fa-wind', color: 'text-white', top: '20%', left: '80%', size: '3rem', rotate: '0deg' } },
                    { name: 'Succulent Leaves', cost: 6, stats: { atk: 0, sur: 25, eva: 0, def: 0 }, desc: 'Fleshy tissues retain moisture in arid substrate.', visual: { type: 'attachment', icon: 'fa-droplet', color: 'text-green-300', top: '40%', left: '20%', size: '2rem', rotate: '0deg' } },
                    { name: 'Hairy Leaves', cost: 4, stats: { atk: 0, sur: 15, eva: 0, def: 0 }, desc: 'Fine fibers trap humidity and reflect harsh light.', visual: { type: 'attachment', icon: 'fa-feather', color: 'text-stone-300', top: '30%', left: '70%', size: '2rem', rotate: '0deg' } },
                    { name: 'Root Network', cost: 7, stats: { atk: 0, sur: 20, eva: 0, def: 20 }, desc: 'Web of fibers holds loose substrate together.', visual: { type: 'attachment', icon: 'fa-network-wired', color: 'text-stone-600', top: '90%', left: '20%', size: '3rem', rotate: '0deg' } },
                    { name: 'Silver Hairs', cost: 5, stats: { atk: 0, sur: 20, eva: 0, def: 0 }, desc: 'Light-colored surface reflects excess solar radiation.', visual: { type: 'filter', val: 'brightness(1.5)' } },
                    { name: 'Bitter Sap', cost: 6, stats: { atk: 25, sur: 0, eva: 0, def: 10 }, desc: 'Unpalatable chemicals deter grazing animals.', visual: { type: 'attachment', icon: 'fa-skull', color: 'text-purple-700', top: '70%', left: '20%', size: '2rem', rotate: '0deg' } }
                ]
            }
        ];

        let currentScenario = null;
        let selectedTraits = new Set();
        let currentPoints = 40;
        let currentStats = { atk: 0, def: 0, sur: 0, eva: 0 };
        let isSurvived = false;

        const viewSelection = document.getElementById('view-selection');
        const viewLab = document.getElementById('view-lab');
        const viewResult = document.getElementById('view-result');
        const pointsDisplay = document.getElementById('points-display');
        const pointsValue = document.getElementById('current-points');
        const creatureContainer = document.getElementById('creature-container');

        function init() {
            const grid = document.querySelector('#view-selection .grid');
            grid.innerHTML = '';
            scenarios.forEach(s => {
                const card = document.createElement('div');
                card.className = `${s.color} rounded-2xl p-6 cursor-pointer hover:shadow-xl transition-all hover:scale-105 border-2 border-transparent hover:border-current group relative overflow-hidden flex flex-col items-center text-center`;
                card.innerHTML = `
                    <div class="absolute inset-0 bg-white/50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="relative z-10">
                        <div class="bg-white/80 p-4 rounded-full mb-4 inline-block shadow-sm">
                            <i class="fa-solid ${s.icon} text-5xl"></i>
                        </div>
                        <h3 class="text-2xl font-black mb-1">${s.name}</h3>
                        <p class="text-xs font-bold uppercase tracking-wide opacity-70">${s.envTitle}</p>
                    </div>
                `;
                card.onclick = () => startScenario(s);
                grid.appendChild(card);
            });
        }

        function startScenario(scenario) {
            currentScenario = scenario;
            selectedTraits.clear();
            currentPoints = 40;
            currentStats = { atk: 0, def: 0, sur: 0, eva: 0 };

            viewSelection.classList.add('hidden');
            viewLab.classList.remove('hidden');
            pointsDisplay.classList.remove('hidden');
            updatePointsUI();
            
            document.getElementById('env-title').innerText = scenario.envTitle;
            document.getElementById('env-desc').innerText = scenario.envDesc;
            document.getElementById('stage-bg').src = scenario.bgUrl;

            const tbody = scenario.challenges.map(c => `
                <div class="mb-2 text-xs">
                    <span class="font-bold text-red-800 block">${c.name}${c.critical ? '*' : ''}</span>
                    <span class="text-slate-600">${c.desc}</span>
                </div>
            `).join('');
            document.getElementById('env-conditions-table').innerHTML = tbody;

            updateVisuals();

            const grid = document.getElementById('traits-grid');
            grid.innerHTML = '';
            scenario.traits.forEach((trait, index) => {
                const el = document.createElement('div');
                el.className = 'trait-card bg-white border border-slate-200 rounded-xl p-4 cursor-pointer flex flex-col relative';
                el.onclick = () => toggleTrait(index, el);
                el.innerHTML = `
                    <div class="absolute top-2 right-2 text-green-500 check-icon">
                        <i class="fa-solid fa-circle-check text-xl"></i>
                    </div>
                    <div class="flex justify-between items-start mb-2 pr-6">
                        <h4 class="font-bold text-slate-800 text-sm">${trait.name}</h4>
                        <span class="bg-slate-800 text-white px-2 py-0.5 rounded text-xs font-bold">${trait.cost} DNA</span>
                    </div>
                    <p class="text-xs text-slate-500 mb-3 leading-snug">${trait.desc}</p>
                    <div class="flex flex-wrap gap-1 mt-auto">
                        ${getStatBadge('Atk', trait.stats.atk)}
                        ${getStatBadge('Def', trait.stats.def)}
                        ${getStatBadge('Sur', trait.stats.sur)}
                        ${getStatBadge('Eva', trait.stats.eva)}
                    </div>
                `;
                grid.appendChild(el);
            });
            updateStatsUI();
        }

        function getStatBadge(label, val) {
            if (val === 0) return '';
            const color = val > 0 ? 'text-green-700 bg-green-100' : 'text-red-600 bg-red-100';
            const sign = val > 0 ? '+' : '';
            return `<span class="text-[10px] px-1.5 py-0.5 rounded ${color} font-bold">${label} ${sign}${val}</span>`;
        }

        function toggleTrait(index, element) {
            const trait = currentScenario.traits[index];
            if (selectedTraits.has(index)) {
                selectedTraits.delete(index);
                currentPoints += trait.cost;
                element.classList.remove('selected');
                updateStats(trait, false);
            } else {
                if (currentPoints >= trait.cost) {
                    selectedTraits.add(index);
                    currentPoints -= trait.cost;
                    element.classList.add('selected');
                    updateStats(trait, true);
                } else {
                    pointsDisplay.classList.add('animate-pulse', 'bg-red-800', 'text-white');
                    setTimeout(() => pointsDisplay.classList.remove('animate-pulse', 'bg-red-800', 'text-white'), 500);
                }
            }
            updatePointsUI();
            updateStatsUI();
            updateVisuals();
        }

        function updateStats(trait, isAdding) {
            const multiplier = isAdding ? 1 : -1;
            currentStats.atk += trait.stats.atk * multiplier;
            currentStats.def += trait.stats.def * multiplier;
            currentStats.sur += trait.stats.sur * multiplier;
            currentStats.eva += trait.stats.eva * multiplier;
        }

        function updatePointsUI() {
            pointsValue.innerText = currentPoints;
            const used = 40 - currentPoints;
            const pct = (used / 40) * 100;
            document.getElementById('evolution-progress').style.width = `${pct}%`;
        }

        function updateStatsUI() {
            document.getElementById('val-atk').innerText = currentStats.atk;
            document.getElementById('val-def').innerText = currentStats.def;
            document.getElementById('val-sur').innerText = currentStats.sur;
            document.getElementById('val-eva').innerText = currentStats.eva;
            const max = 100; 
            document.getElementById('bar-atk').style.width = Math.min(100, Math.max(0, (currentStats.atk / max) * 100)) + '%';
            document.getElementById('bar-def').style.width = Math.min(100, Math.max(0, (currentStats.def / max) * 100)) + '%';
            document.getElementById('bar-sur').style.width = Math.min(100, Math.max(0, (currentStats.sur / max) * 100)) + '%';
            document.getElementById('bar-eva').style.width = Math.min(100, Math.max(0, (currentStats.eva / max) * 100)) + '%';
        }

        function buildCreature(container, scale = 1, options = {}) {
            container.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = `relative flex items-center justify-center transition-all duration-500`;
            wrapper.style.width = '16rem'; 
            wrapper.style.height = '16rem';
            if (options.className) wrapper.className += ' ' + options.className;
            
            const scaler = document.createElement('div');
            scaler.className = 'relative w-full h-full flex items-center justify-center';
            scaler.style.transform = `scale(${scale})`;
            
            const layers = document.createElement('div');
            layers.className = 'absolute inset-0 flex items-center justify-center pointer-events-none w-full h-full';
            layers.style.zIndex = '5';

            const base = document.createElement('i');
            base.className = `fa-solid ${currentScenario.baseIcon} text-[10rem] text-white drop-shadow-2xl filter transition-all duration-500 relative`;
            base.style.zIndex = '10';
            base.style.color = 'white'; 
            base.style.transform = 'scale(1)'; 

            const accs = document.createElement('div');
            accs.className = 'absolute inset-0 pointer-events-none w-full h-full';
            accs.style.zIndex = '20';

            selectedTraits.forEach(idx => {
                const trait = currentScenario.traits[idx];
                const visuals = Array.isArray(trait.visual) ? trait.visual : [trait.visual];
                
                visuals.forEach(vis => {
                    if (!vis) return;
                    if (vis.type === 'color') {
                        base.style.color = vis.val;
                    } else if (vis.type === 'scale') {
                        base.style.transform = `scale(${vis.val})`; 
                    } else if (vis.type === 'filter') {
                        base.style.filter = `${vis.val} drop-shadow(0 20px 13px rgba(0,0,0,0.5))`;
                    } else if (vis.type === 'attachment') {
                        const acc = document.createElement('i');
                        acc.className = `accessory-icon fa-solid ${vis.icon} ${vis.color}`;
                        acc.style.top = vis.top;
                        acc.style.left = vis.left;
                        acc.style.fontSize = vis.size;
                        acc.style.transform = `translate(-50%, -50%) rotate(${vis.rotate})`;
                        accs.appendChild(acc);
                    } else if (vis.type === 'layer') {
                        const layer = document.createElement('i');
                        layer.className = `absolute inset-0 flex items-center justify-center fa-solid ${currentScenario.baseIcon} ${vis.color}`;
                        layer.style.fontSize = '10rem'; 
                        layer.style.transform = `scale(${vis.scale})`;
                        layer.style.opacity = vis.opacity;
                        if(vis.filter) layer.style.filter = vis.filter;
                        layers.appendChild(layer);
                    }
                });
            });

            scaler.appendChild(layers);
            scaler.appendChild(base);
            scaler.appendChild(accs);
            wrapper.appendChild(scaler);
            container.appendChild(wrapper);
        }

        function updateVisuals() {
            const container = document.getElementById('creature-container');
            buildCreature(container, 1, { className: 'floating' });
        }

        function calculateResults() {
            if (selectedTraits.size === 0) {
                alert("Please select at least one adaptation!");
                return;
            }

            viewLab.classList.add('hidden');
            viewResult.classList.remove('hidden');
            pointsDisplay.classList.add('hidden');

            // 1. Env Context
            document.getElementById('res-env-title').innerText = currentScenario.envTitle;
            document.getElementById('res-env-desc').innerText = currentScenario.envDesc;
            
            const challengesList = document.getElementById('res-env-challenges');
            challengesList.innerHTML = currentScenario.challenges.map(c => `
                <div class="bg-white p-3 rounded-lg border border-red-100 shadow-sm">
                    <h5 class="font-bold text-red-800 text-sm mb-1">${c.name}${c.critical ? '*' : ''}</h5>
                    <p class="text-xs text-slate-600 leading-snug">${c.desc}</p>
                </div>
            `).join('');

            // 2. Updated Traits Grid (All Traits with Status)
            const traitsList = document.getElementById('result-traits-list');
            traitsList.innerHTML = currentScenario.traits.map((t, idx) => {
                const isSelected = selectedTraits.has(idx);
                // Styles for selected vs unselected
                const containerClass = isSelected 
                    ? "bg-green-50 border-green-300 ring-1 ring-green-300 shadow-md" 
                    : "bg-slate-50 border-slate-200 opacity-60 grayscale-[0.5]";
                
                const icon = isSelected 
                    ? `<div class="bg-green-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow-sm"><i class="fa-solid fa-check text-xs"></i></div>`
                    : `<div class="bg-slate-200 text-slate-400 w-6 h-6 rounded-full flex items-center justify-center"><i class="fa-solid fa-minus text-xs"></i></div>`;
                
                const label = isSelected 
                    ? `<span class="text-[10px] font-bold uppercase text-green-600 bg-green-100 px-2 py-0.5 rounded">Active</span>`
                    : `<span class="text-[10px] font-bold uppercase text-slate-500 bg-slate-200 px-2 py-0.5 rounded">Not Selected</span>`;

                return `
                    <div class="flex items-start gap-3 p-4 rounded-xl border ${containerClass} transition-all">
                        <div class="mt-1 flex-shrink-0">${icon}</div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-slate-800 text-sm">${t.name}</h4>
                                ${label}
                            </div>
                            <p class="text-xs text-slate-500 mt-1 leading-snug">${t.desc}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // Clone Stats
            const statsClone = document.getElementById('stats-bars-container').cloneNode(true);
            const resCloneContainer = document.getElementById('result-stats-clone');
            resCloneContainer.innerHTML = '';
            resCloneContainer.appendChild(statsClone);

            // 3. Survival Analysis Logic
            let passedChallenges = 0;
            let criticalFail = false;
            let failedCount = 0;
            let challengeRowsHTML = '';

            currentScenario.challenges.forEach(challenge => {
                let passed = false;
                let contributors = [];

                if (challenge.requiredTrait) {
                    const required = Array.isArray(challenge.requiredTrait) ? challenge.requiredTrait : [challenge.requiredTrait];
                    
                    // Find if any selected trait matches requirement
                    Array.from(selectedTraits).forEach(idx => {
                        const tName = currentScenario.traits[idx].name;
                        if(required.includes(tName)) {
                            passed = true;
                            contributors.push(tName);
                        }
                    });

                } else {
                    // Check stats
                    let statsPassed = true;
                    challenge.stats.forEach(statKey => {
                        if (currentStats[statKey] < challenge.min) statsPassed = false;
                    });
                    
                    if (statsPassed) {
                        passed = true;
                        // Identify which selected traits provided positive value to the required stats
                        Array.from(selectedTraits).forEach(idx => {
                            const t = currentScenario.traits[idx];
                            // If this trait gives >0 to any of the required stats, it's a contributor
                            const helps = challenge.stats.some(k => t.stats[k] > 0);
                            if(helps) contributors.push(t.name);
                        });
                    }
                }

                // Formatting the Contributor String
                let contribString = "";
                if (contributors.length > 0) {
                    contribString = contributors.map(c => `<span class="inline-block bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded font-bold mr-1 mb-1">${c}</span>`).join('');
                } else if (!passed) {
                    contribString = `<span class="text-red-400 text-xs italic">Missing necessary adaptation</span>`;
                }

                if (passed) {
                    passedChallenges++;
                    challengeRowsHTML += `
                        <tr class="border-b border-slate-700 last:border-0 hover:bg-slate-750">
                            <td class="px-6 py-4 font-medium text-slate-300">${challenge.name}</td>
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-green-900/50 text-green-400 border border-green-800">
                                    <i class="fa-solid fa-check"></i> Overcome
                                </span>
                            </td>
                            <td class="px-6 py-4">${contribString}</td>
                        </tr>`;
                } else {
                    failedCount++;
                    if (challenge.critical) criticalFail = true;
                    challengeRowsHTML += `
                        <tr class="border-b border-slate-700 last:border-0 hover:bg-slate-750">
                            <td class="px-6 py-4 font-medium text-slate-300">${challenge.name}</td>
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-red-900/50 text-red-400 border border-red-800">
                                    <i class="fa-solid fa-xmark"></i> Failed
                                </span>
                            </td>
                            <td class="px-6 py-4">${contribString}</td>
                        </tr>`;
                }
            });

            document.getElementById('result-conditions-table-body').innerHTML = challengeRowsHTML;

            // 4. Verdict Logic
            let tier = "";
            let title = "";
            let message = "";
            let colorClass = "";
            let offspringCount = 0;
            let isDead = false;

            if (criticalFail || failedCount >= 5) {
                tier = "extinct";
                title = "Extinction Event";
                message = criticalFail 
                    ? "Critical failure detected. A key survival requirement was not met."
                    : "Overwhelmed by environmental stressors.";
                colorClass = "text-red-400";
                isDead = true;
                offspringCount = 0;
            } else if (failedCount >= 3) {
                tier = "struggling";
                title = "Near Extinction";
                message = "Barely surviving. The population is stressed and dwindling.";
                colorClass = "text-orange-400";
                offspringCount = 1;
            } else if (failedCount >= 1) {
                tier = "surviving";
                title = "Resilient Survivors";
                message = "Doing well. Adaptations are sufficient for a stable population.";
                colorClass = "text-yellow-400";
                offspringCount = 2;
            } else {
                tier = "apex";
                title = "Apex Species";
                message = "Perfect adaptation. Domination of the ecosystem.";
                colorClass = "text-green-400";
                offspringCount = 4;
            }

            document.getElementById('result-title').innerText = title;
            document.getElementById('result-title').className = `text-5xl font-black mb-4 ${colorClass}`;
            document.getElementById('result-feedback').innerText = message;
            
            let score = 0;
            if(tier === 'apex') score = 100;
            else if(tier === 'surviving') score = 80;
            else if(tier === 'struggling') score = 40;
            else score = 0;
            document.getElementById('final-score-badge').innerText = `Score: ${score}%`;

            // Visuals
            const resultStage = document.getElementById('result-creature-stage');
            resultStage.innerHTML = ''; 

            if (isDead) {
                const deadContainer = document.createElement('div');
                resultStage.appendChild(deadContainer);
                buildCreature(deadContainer, 1, { className: 'dead-creature' });
            } else {
                const scene = document.createElement('div');
                scene.className = 'relative flex items-center justify-center';
                scene.style.width = '200px';
                scene.style.height = '200px';
                resultStage.appendChild(scene);

                const main = document.createElement('div');
                main.className = 'z-10 relative';
                scene.appendChild(main);
                
                let mainAnim = tier === 'apex' ? 'happy-bounce' : 'floating';
                if(tier === 'struggling') mainAnim = ''; 

                buildCreature(main, 1.2, { className: mainAnim });

                const offsets = [
                    { x: -140, y: 60, s: 0.5 },
                    { x: 140, y: 50, s: 0.6 },
                    { x: -180, y: 20, s: 0.4 },
                    { x: 190, y: 80, s: 0.45 }
                ];

                for(let i=0; i<Math.min(offspringCount, offsets.length); i++) {
                    const cfg = offsets[i];
                    const off = document.createElement('div');
                    off.className = 'absolute offspring-container z-0';
                    off.style.transform = `translate(${cfg.x}px, ${cfg.y}px)`; 
                    scene.appendChild(off);
                    buildCreature(off, cfg.s, { className: 'floating' });
                }
            }
        }

        function resetLab() {
            viewResult.classList.add('hidden');
            viewSelection.classList.remove('hidden');
        }

        init();
    </script>
</body>
</html>
