<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolutionary Adaptation Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Fredoka', sans-serif; background-color: #f8fafc; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .trait-card { transition: all 0.2s ease; }
        .trait-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .trait-card.selected { border-color: #22c55e; background-color: #f0fdf4; box-shadow: 0 0 0 3px #22c55e; }
        .trait-card .check-icon { display: none; }
        .trait-card.selected .check-icon { display: block; }
        .stat-bar-fill { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .creature-base { transition: all 0.5s ease-in-out; position: relative; z-index: 10; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .floating { animation: float 4s ease-in-out infinite; }
        @keyframes bounce-happy { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .happy-bounce { animation: bounce-happy 1.5s infinite ease-in-out; }
        .accessory-icon { position: absolute; display: flex; align-items: center; justify-content: center; transform-origin: center; pointer-events: none; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .dead-creature { filter: grayscale(100%) brightness(70%); transform: rotate(180deg); opacity: 0.8; }
        .offspring-container { opacity: 0.9; filter: brightness(1.1); }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #86efac; border-radius: 6px; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col bg-slate-50 text-lg">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-6 shadow-xl sticky top-0 z-50 border-b-8 border-green-500">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-5">
                <div class="bg-green-500 p-4 rounded-2xl shadow-lg shadow-green-500/20">
                    <i class="fa-solid fa-dna text-4xl text-white"></i>
                </div>
                <div>
                    <h1 class="text-4xl font-black tracking-wide">Nature's Adapter</h1>
                    <p class="text-xl text-slate-300 font-bold mt-1 uppercase tracking-widest">3.3 Adaptation & Habitat</p>
                </div>
            </div>
            <div id="points-display" class="hidden bg-slate-800 border-2 border-slate-700 px-8 py-4 rounded-full font-bold flex items-center gap-5 shadow-inner">
                <span class="text-slate-300 text-xl uppercase tracking-wider font-black">DNA Points</span>
                <span id="current-points" class="text-green-400 text-5xl font-black">30</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-8 max-w-[95%] mx-auto w-full">
        
        <!-- View 1: Scenario Selection -->
        <div id="view-selection" class="animate-pop block py-12">
            <div class="text-center mb-16">
                <h2 class="text-6xl font-black text-slate-900 mb-6">Select an Environment</h2>
                <p class="text-slate-500 text-2xl max-w-4xl mx-auto font-medium">Choose a subject to evolve. You have 30 DNA Points to survive 4 Harsh Conditions.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 max-w-5xl mx-auto">
                <!-- Cards generated by JS -->
            </div>
        </div>

        <!-- View 2: Evolution Lab -->
        <div id="view-lab" class="hidden animate-pop h-full flex flex-col">
            
            <!-- TOP ROW: Conditions (Left) & Adaptations (Right) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                
                <!-- LEFT: Environment & Conditions -->
                <div class="bg-white rounded-[2rem] shadow-sm border-2 border-slate-200 p-8 flex flex-col h-full">
                    <h3 id="env-title" class="text-5xl font-black text-slate-800 mb-4">Env Title</h3>
                    <p id="env-desc" class="text-slate-600 mb-8 text-xl leading-relaxed"></p>
                    
                    <div class="bg-red-50 p-8 rounded-3xl border-2 border-red-100 flex-grow">
                        <div class="flex items-center gap-4 mb-6 text-red-800 font-bold border-b-2 border-red-200 pb-4">
                            <i class="fa-solid fa-triangle-exclamation text-3xl"></i>
                            <h4 class="text-3xl font-black">4 Harsh Conditions</h4>
                        </div>
                        <div id="env-conditions-table" class="space-y-6">
                            <!-- Conditions Injected Here -->
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Adaptation Selection -->
                <div class="bg-slate-100 rounded-[2rem] p-6 border-2 border-slate-200 flex flex-col h-full">
                    <h3 class="font-black text-slate-500 uppercase text-lg tracking-widest flex justify-between items-center mb-4 px-2">
                        <span>Select Adaptations</span>
                        <span class="text-sm bg-white border border-slate-300 px-3 py-1 rounded-full text-slate-600 font-bold">Scroll for more</span>
                    </h3>
                    <div id="traits-grid" class="grid grid-cols-1 gap-4 overflow-y-auto pr-2" style="max-height: 600px;">
                        <!-- Traits Injected Here -->
                    </div>
                </div>
            </div>

            <!-- BOTTOM ROW: Visuals & Stats -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Visuals (Left/Center) -->
                <div class="lg:col-span-8">
                    <div class="relative w-full h-96 rounded-[2.5rem] overflow-hidden shadow-2xl border-8 border-white bg-slate-900 group">
                        <img id="stage-bg" src="" class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110 opacity-80" alt="Habitat">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-transparent to-transparent"></div>
                        <div class="absolute inset-0 flex items-center justify-center z-10">
                            <div id="creature-container" class="relative w-80 h-80 flex items-center justify-center floating transition-all duration-500"></div>
                        </div>
                        <div class="absolute bottom-8 left-8 right-8 z-30">
                            <div class="text-white text-lg font-black uppercase tracking-widest mb-2 opacity-90 drop-shadow-md">Evolution Progress</div>
                            <div class="h-6 w-full bg-slate-700/50 backdrop-blur rounded-full overflow-hidden border-2 border-white/20">
                                <div id="evolution-progress" class="h-full bg-green-400 transition-all duration-500 w-0 shadow-[0_0_15px_rgba(74,222,128,0.8)]"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats (Right) & Button -->
                <div class="lg:col-span-4 flex flex-col gap-6">
                    <div class="bg-white rounded-[2rem] shadow-sm border-2 border-slate-200 p-6 flex-grow">
                        <h3 class="font-black text-slate-800 mb-6 flex items-center gap-3 border-b-2 pb-4 text-2xl">
                            <i class="fa-solid fa-chart-pie text-3xl text-blue-500"></i> Vital Stats
                        </h3>
                        <div id="stats-bars-container" class="space-y-6">
                            <div class="group">
                                <div class="flex justify-between text-base font-black text-slate-600 mb-1">
                                    <span class="flex items-center gap-2"><i class="fa-solid fa-khanda text-red-500"></i> ATTACK</span>
                                    <span id="val-atk" class="bg-slate-100 px-3 py-0.5 rounded-lg text-slate-800">0</span>
                                </div>
                                <div class="h-5 bg-slate-100 rounded-full overflow-hidden relative border border-slate-200">
                                    <div class="absolute left-0 top-0 bottom-0 border-r-2 border-white/50 z-10 w-[20%]"></div>
                                    <div id="bar-atk" class="h-full bg-gradient-to-r from-red-400 to-red-600 stat-bar-fill w-0"></div>
                                </div>
                            </div>
                            <div class="group">
                                <div class="flex justify-between text-base font-black text-slate-600 mb-1">
                                    <span class="flex items-center gap-2"><i class="fa-solid fa-shield-halved text-blue-500"></i> DEFENSE</span>
                                    <span id="val-def" class="bg-slate-100 px-3 py-0.5 rounded-lg text-slate-800">0</span>
                                </div>
                                <div class="h-5 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                                    <div id="bar-def" class="h-full bg-gradient-to-r from-blue-400 to-blue-600 stat-bar-fill w-0"></div>
                                </div>
                            </div>
                            <div class="group">
                                <div class="flex justify-between text-base font-black text-slate-600 mb-1">
                                    <span class="flex items-center gap-2"><i class="fa-solid fa-heart-pulse text-green-500"></i> SURVIVAL</span>
                                    <span id="val-sur" class="bg-slate-100 px-3 py-0.5 rounded-lg text-slate-800">0</span>
                                </div>
                                <div class="h-5 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                                    <div id="bar-sur" class="h-full bg-gradient-to-r from-green-400 to-green-600 stat-bar-fill w-0"></div>
                                </div>
                            </div>
                            <div class="group">
                                <div class="flex justify-between text-base font-black text-slate-600 mb-1">
                                    <span class="flex items-center gap-2"><i class="fa-solid fa-wind text-yellow-500"></i> EVASION</span>
                                    <span id="val-eva" class="bg-slate-100 px-3 py-0.5 rounded-lg text-slate-800">0</span>
                                </div>
                                <div class="h-5 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                                    <div id="bar-eva" class="h-full bg-gradient-to-r from-yellow-400 to-yellow-600 stat-bar-fill w-0"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="calculateResults()" class="w-full bg-green-600 hover:bg-green-700 text-white px-8 py-6 rounded-[2rem] font-black shadow-xl shadow-green-600/20 transition-all transform hover:scale-105 flex items-center justify-center gap-4 text-3xl group border-b-8 border-green-800 active:border-b-0 active:translate-y-2">
                        Test Survival <i class="fa-solid fa-flask group-hover:rotate-12 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- View 3: Results -->
        <div id="view-result" class="hidden animate-pop max-w-[95%] mx-auto w-full py-12 px-6">
            
            <div class="space-y-16">
                <!-- 1. Environmental Context Card -->
                <div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-2 border-slate-200">
                    <div class="bg-slate-800 px-12 py-8">
                        <h2 class="text-4xl font-black text-white flex items-center gap-6">
                            <span class="bg-slate-700 w-12 h-12 rounded-full flex items-center justify-center text-2xl border-2 border-slate-500">1</span> 
                            Environmental Context
                        </h2>
                    </div>
                    <div class="p-12">
                        <h3 id="res-env-title" class="text-6xl font-black text-slate-800 mb-6">Environment Title</h3>
                        <p id="res-env-desc" class="text-slate-600 mb-10 text-2xl leading-relaxed">...</p>
                        
                        <div class="bg-red-50 rounded-3xl p-10 border-2 border-red-100">
                            <h4 class="font-black text-red-900 mb-8 uppercase text-xl tracking-widest border-b-2 border-red-200 pb-4">4 Harsh Conditions Identified</h4>
                            <div id="res-env-challenges" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- JS Injected Challenges -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Organism Design Card -->
                <div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-2 border-slate-200">
                    <div class="bg-slate-800 px-12 py-8">
                        <h2 class="text-4xl font-black text-white flex items-center gap-6">
                            <span class="bg-slate-700 w-12 h-12 rounded-full flex items-center justify-center text-2xl border-2 border-slate-500">2</span> 
                            Your Design Configuration
                        </h2>
                    </div>
                    <div class="p-12">
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                            <!-- Visual (4 cols) -->
                            <div class="lg:col-span-4 flex flex-col gap-10">
                                <div id="result-creature-stage" class="relative h-96 w-full bg-slate-50 rounded-[2rem] border-4 border-slate-100 flex justify-center items-center overflow-hidden shadow-inner bg-gradient-to-b from-slate-50 to-slate-100">
                                    <!-- Creature -->
                                </div>
                                <div class="bg-white border-2 border-slate-200 rounded-3xl p-8">
                                    <h3 class="font-black text-slate-800 mb-6 uppercase text-lg tracking-widest border-b-2 border-slate-100 pb-4">Final Statistics</h3>
                                    <div id="result-stats-clone"></div>
                                </div>
                            </div>

                            <!-- Traits (8 cols) -->
                            <div class="lg:col-span-8">
                                <h3 class="font-black text-slate-800 mb-8 flex items-center gap-4 text-3xl">
                                    <i class="fa-solid fa-dna text-blue-600"></i> All Available Adaptations
                                </h3>
                                <div id="result-traits-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[700px] overflow-y-auto pr-4">
                                    <!-- JS Injected Traits -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Survival Analysis & Verdict -->
                <div class="bg-slate-900 rounded-[2.5rem] shadow-2xl overflow-hidden border-4 border-slate-800 text-white">
                    <div class="px-12 py-10 border-b-2 border-slate-700 flex justify-between items-center">
                        <h2 class="text-4xl font-black flex items-center gap-6">
                            <span class="bg-slate-700 w-12 h-12 rounded-full flex items-center justify-center text-2xl border-2 border-slate-500">3</span> 
                            Survival Analysis Report
                        </h2>
                        <div id="final-score-badge" class="bg-slate-800 px-8 py-3 rounded-full text-3xl font-black text-green-400 border-2 border-slate-600">
                            Score: 0%
                        </div>
                    </div>
                    
                    <div class="p-12">
                        <!-- Analysis Table -->
                        <div class="bg-slate-800 rounded-3xl overflow-hidden mb-12 border-2 border-slate-700">
                            <table class="w-full text-left text-xl">
                                <thead class="bg-slate-700 text-slate-300 uppercase font-black text-lg">
                                    <tr>
                                        <th class="px-10 py-6 w-1/4">Harsh Condition</th>
                                        <th class="px-10 py-6 w-1/4">Survival Outcome</th>
                                        <th class="px-10 py-6 w-1/2">Contributing Adaptations</th>
                                    </tr>
                                </thead>
                                <tbody id="result-conditions-table-body" class="divide-y-2 divide-slate-700 text-slate-200 font-medium">
                                    <!-- JS Injected Rows -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Final Verdict -->
                        <div class="text-center pt-8">
                            <div class="inline-block bg-slate-800 rounded-full px-8 py-3 text-lg font-black text-slate-400 uppercase tracking-widest mb-8 border-2 border-slate-700">Evolutionary Result</div>
                            <h3 id="result-title" class="text-7xl font-black mb-8 bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">Result Title</h3>
                            <p id="result-feedback" class="text-3xl text-slate-400 max-w-4xl mx-auto font-light leading-relaxed">...</p>
                            
                            <div class="mt-16">
                                <button onclick="resetLab()" class="bg-white hover:bg-slate-100 text-slate-900 font-black py-6 px-16 rounded-[2rem] shadow-2xl transition-all transform hover:scale-105 active:scale-95 text-2xl border-b-8 border-slate-300 active:border-b-0 active:translate-y-2">
                                    Test Another Environment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- JavaScript Logic -->
    <script>
        // Data
        const scenarios = [
            {
                id: 'bear',
                name: 'Polar Bear',
                icon: 'fa-paw',
                baseIcon: 'fa-dog', 
                color: 'bg-slate-100 border-slate-300 text-slate-900',
                envTitle: 'The Frozen North',
                envDesc: 'A land of ice and snow. It is extremely cold and slippery. Food is hard to find because it hides under the ice.',
                bgUrl: 'https://i.ibb.co/RpN11Bwk/Arctic-1024x576.png',
                challenges: [
                    { name: "Freezing Cold", desc: "Temperatures are -50°C. You will freeze without protection.", requiredTrait: ["Thick White Fur", "Blubber Layer"], stats: ["sur"], min: 40, critical: true },
                    { name: "Slippery Ice", desc: "The ground is ice. You cannot walk without grip.", requiredTrait: ["Rough Paws", "Sharp Claws"], stats: ["eva"], min: 30, critical: true },
                    { name: "Invisible Prey", desc: "Seals hide under the snow. You need to find them.", requiredTrait: "Super Smell", stats: ["atk"], min: 25, critical: false },
                    { name: "Open Ocean", desc: "The ice melts. You must swim miles to find land.", requiredTrait: ["Webbed Paws"], stats: ["sur"], min: 20, critical: true }
                ], 
                traits: [
                    { name: 'Thick White Fur', cost: 7, stats: { atk: 0, sur: 40, eva: 0, def: 10 }, desc: 'Keeps you warm and helps you hide in snow.', visual: { type: 'color', val: '#f8fafc' } },
                    { name: 'Blubber Layer', cost: 8, stats: { atk: 0, sur: 30, eva: -5, def: 5 }, desc: 'Thick fat under the skin to stop the cold.', visual: { type: 'scale', val: 1.2 } },
                    { name: 'Sharp Claws', cost: 6, stats: { atk: 25, sur: 0, eva: 10, def: 0 }, desc: 'Dig into ice so you do not slip.', visual: { type: 'attachment', icon: 'fa-slash', color: 'text-slate-600', top: '80%', left: '10%', size: '3rem', rotate: '45deg' } },
                    { name: 'Webbed Paws', cost: 7, stats: { atk: 0, sur: 10, eva: 25, def: 0 }, desc: 'Works like a paddle for swimming in deep water.', visual: { type: 'attachment', icon: 'fa-paw', color: 'text-slate-400', top: '90%', left: '50%', size: '3rem', rotate: '0deg' } },
                    { name: 'Super Smell', cost: 7, stats: { atk: 20, sur: 10, eva: 0, def: 0 }, desc: 'Smell food from miles away.', visual: { type: 'attachment', icon: 'fa-wind', color: 'text-blue-300', top: '35%', left: '5%', size: '2rem', rotate: '0deg' } },
                    { name: 'Small Ears', cost: 4, stats: { atk: 0, sur: 15, eva: 0, def: 0 }, desc: 'Less body heat is lost through small ears.', visual: { type: 'attachment', icon: 'fa-ear-deaf', color: 'text-slate-400', top: '20%', left: '10%', size: '1.5rem', rotate: '0deg' } },
                    // TRICK TRAITS
                    { name: 'Jungle Green Fur', cost: 5, stats: { atk: 0, sur: -20, eva: -10, def: 0 }, desc: 'Great for hiding in a green forest, but useless here.', visual: { type: 'color', val: '#22c55e' } },
                    { name: 'Tree-Climbing Tail', cost: 5, stats: { atk: 0, sur: 0, eva: 20, def: 0 }, desc: 'Great for grabbing tree branches (but there are no trees).', visual: { type: 'attachment', icon: 'fa-question', color: 'text-slate-500', top: '80%', left: '80%', size: '2rem', rotate: '20deg' } },
                    { name: 'Camel Hump', cost: 6, stats: { atk: 0, sur: 30, eva: -10, def: 0 }, desc: 'Stores water for days. (Great for hot deserts!)', visual: { type: 'attachment', icon: 'fa-mound', color: 'text-orange-400', top: '20%', left: '50%', size: '3rem', rotate: '0deg' } },
                    { name: 'Echolocation', cost: 8, stats: { atk: 20, sur: 0, eva: 0, def: 0 }, desc: 'Find prey with sound. (Only works underwater or in environment with a lot of terrain like trees and caves!)', visual: { type: 'attachment', icon: 'fa-rss', color: 'text-indigo-400', top: '35%', left: '20%', size: '2rem', rotate: '0deg' } }
                ]
            },
            {
                id: 'shark',
                name: 'Deep Sea Shark',
                icon: 'fa-fish', 
                baseIcon: 'fa-fish', 
                color: 'bg-indigo-50 border-indigo-200 text-indigo-900',
                envTitle: 'Deep Sea',
                envDesc: 'The bottom of the ocean. It is totally dark and the weight of the water is heavy.',
                bgUrl: 'https://i.ibb.co/6cDmgv41/2019-07t062706-edited.jpg', 
                challenges: [
                    { name: "Pitch Black", desc: "There is no light. You cannot see.", requiredTrait: ["Glow Skin", "Electro-Sense", "Big Eyes"], stats: ["atk"], min: 30, critical: true },
                    { name: "Crushing Weight", desc: "The water pushes down hard. It breaks bones.", requiredTrait: "Rubber Skeleton", stats: ["sur"], min: 40, critical: true },
                    { name: "Freezing Cold", desc: "The water is very, very cold.", requiredTrait: "Never-Freeze Blood", stats: ["sur"], min: 25, critical: false },
                    { name: "Tough Meat", desc: "Prey has thick skin. It is hard to eat.", requiredTrait: ["Needle Teeth", "Torpedo Shape"], stats: ["atk", "eva"], min: 25, critical: false }
                ],
                traits: [
                    { name: 'Glow Skin', cost: 6, stats: { atk: 10, sur: 0, eva: 0, def: 0 }, desc: 'Make your own light to see.', visual: { type: 'filter', val: 'drop-shadow(0 0 30px #facc15)' } },
                    { name: 'Rubber Skeleton', cost: 10, stats: { atk: 0, sur: 40, eva: 10, def: 0 }, desc: 'Bones bend like rubber so they don’t break under weight.', visual: { type: 'layer', color: 'text-indigo-300', opacity: 0.5, scale: 1.1 } },
                    { name: 'Needle Teeth', cost: 8, stats: { atk: 35, sur: 0, eva: 0, def: 0 }, desc: 'Sharp spikes to tear through tough skin.', visual: { type: 'attachment', icon: 'fa-caret-up', color: 'text-white', top: '65%', left: '10%', size: '2rem', rotate: '-10deg' } },
                    { name: 'Big Eyes', cost: 5, stats: { atk: 15, sur: 0, eva: 5, def: 0 }, desc: 'Catch tiny amounts of light.', visual: { type: 'attachment', icon: 'fa-eye', color: 'text-yellow-200', top: '25%', left: '20%', size: '3.5rem', rotate: '0deg' } },
                    { name: 'Never-Freeze Blood', cost: 6, stats: { atk: 0, sur: 30, eva: 0, def: 0 }, desc: 'Special stuff in your blood stops it from turning into solid ice.', visual: { type: 'attachment', icon: 'fa-droplet', color: 'text-cyan-300', top: '50%', left: '50%', size: '3rem', rotate: '0deg' } },
                    { name: 'Electro-Sense', cost: 7, stats: { atk: 20, sur: 5, eva: 0, def: 0 }, desc: 'Feel electricity of other animals in the dark.', visual: { type: 'attachment', icon: 'fa-bolt', color: 'text-yellow-400', top: '15%', left: '80%', size: '3rem', rotate: '15deg' } },
                    // TRICK TRAITS
                    { name: 'Solar Panels', cost: 5, stats: { atk: 0, sur: -5, eva: 0, def: 0 }, desc: 'Collects energy from the sun. (Wait, is there sun here?)', visual: { type: 'attachment', icon: 'fa-solar-panel', color: 'text-slate-400', top: '40%', left: '50%', size: '3rem', rotate: '0deg' } },
                    { name: 'Walking Legs', cost: 8, stats: { atk: 0, sur: 0, eva: -20, def: 0 }, desc: 'Good for land, but makes you swim very slow.', visual: { type: 'attachment', icon: 'fa-shoe-prints', color: 'text-orange-400', top: '80%', left: '50%', size: '3rem', rotate: '90deg' } },
                    { name: 'Turtle Shell', cost: 9, stats: { atk: 0, sur: 0, eva: -10, def: 40 }, desc: 'Hard armor! (Too heavy for a hunter though).', visual: { type: 'attachment', icon: 'fa-shield', color: 'text-green-800', top: '50%', left: '50%', size: '6rem', rotate: '0deg' } },
                    { name: 'Eagle Wings', cost: 6, stats: { atk: 0, sur: 0, eva: 30, def: 0 }, desc: 'Fly high in the sky!', visual: { type: 'attachment', icon: 'fa-feather', color: 'text-stone-300', top: '30%', left: '70%', size: '4rem', rotate: '0deg' } }
                ]
            }
        ];

        let currentScenario = null;
        let currentTraits = []; // Shuffled array
        let selectedIndices = new Set(); // Stores Indices relative to currentTraits
        let currentPoints = 30;
        let currentStats = { atk: 0, def: 0, sur: 0, eva: 0 };

        const viewSelection = document.getElementById('view-selection');
        const viewLab = document.getElementById('view-lab');
        const viewResult = document.getElementById('view-result');
        const pointsDisplay = document.getElementById('points-display');
        const pointsValue = document.getElementById('current-points');
        const creatureContainer = document.getElementById('creature-container');

        // Helper: Shuffle Array
        function shuffleArray(array) {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function init() {
            const grid = document.querySelector('#view-selection .grid');
            grid.innerHTML = '';
            scenarios.forEach(s => {
                const card = document.createElement('div');
                card.className = `${s.color} rounded-[2rem] p-10 cursor-pointer hover:shadow-xl transition-all hover:scale-105 border-4 border-transparent hover:border-current group relative overflow-hidden flex flex-col items-center text-center`;
                card.innerHTML = `
                    <div class="absolute inset-0 bg-white/50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="relative z-10">
                        <div class="bg-white/80 p-6 rounded-full mb-6 inline-block shadow-sm">
                            <i class="fa-solid ${s.icon} text-7xl"></i>
                        </div>
                        <h3 class="text-4xl font-black mb-2">${s.name}</h3>
                        <p class="text-lg font-bold uppercase tracking-wide opacity-70">${s.envTitle}</p>
                    </div>
                `;
                card.onclick = () => startScenario(s);
                grid.appendChild(card);
            });
        }

        function startScenario(scenario) {
            currentScenario = scenario;
            selectedIndices.clear();
            currentPoints = 30;
            currentStats = { atk: 0, def: 0, sur: 0, eva: 0 };
            
            // Shuffle traits!
            currentTraits = shuffleArray(scenario.traits);

            viewSelection.classList.add('hidden');
            viewLab.classList.remove('hidden');
            pointsDisplay.classList.remove('hidden');
            updatePointsUI();
            
            document.getElementById('env-title').innerText = scenario.envTitle;
            document.getElementById('env-desc').innerText = scenario.envDesc;
            document.getElementById('stage-bg').src = scenario.bgUrl;

            // Fill Conditions (Top Left)
            const tbody = scenario.challenges.map(c => `
                <div class="mb-5 border-b border-red-100 pb-3 last:border-0">
                    <span class="font-black text-red-800 block text-xl mb-1">${c.name}${c.critical ? '*' : ''}</span>
                    <span class="text-slate-600 text-lg leading-snug font-medium">${c.desc}</span>
                </div>
            `).join('');
            document.getElementById('env-conditions-table').innerHTML = tbody;

            updateVisuals();

            // Fill Traits (Top Right)
            const grid = document.getElementById('traits-grid');
            grid.innerHTML = '';
            currentTraits.forEach((trait, index) => {
                const el = document.createElement('div');
                el.className = 'trait-card bg-white border-2 border-slate-200 rounded-3xl p-5 cursor-pointer flex flex-col relative';
                el.onclick = () => toggleTrait(index, el);
                el.innerHTML = `
                    <div class="absolute top-3 right-3 text-green-500 check-icon">
                        <i class="fa-solid fa-circle-check text-3xl"></i>
                    </div>
                    <div class="flex justify-between items-start mb-2 pr-10">
                        <h4 class="font-black text-slate-800 text-xl">${trait.name}</h4>
                        <span class="bg-slate-800 text-white px-3 py-1 rounded-lg text-base font-bold">${trait.cost} DNA</span>
                    </div>
                    <p class="text-base text-slate-500 mb-3 leading-normal font-medium">${trait.desc}</p>
                    <div class="flex flex-wrap gap-2 mt-auto">
                        ${getStatBadge('Atk', trait.stats.atk)}
                        ${getStatBadge('Def', trait.stats.def)}
                        ${getStatBadge('Sur', trait.stats.sur)}
                        ${getStatBadge('Eva', trait.stats.eva)}
                    </div>
                `;
                grid.appendChild(el);
            });
            updateStatsUI();
        }

        function getStatBadge(label, val) {
            if (val === 0) return '';
            const color = val > 0 ? 'text-green-700 bg-green-100' : 'text-red-600 bg-red-100';
            const sign = val > 0 ? '+' : '';
            return `<span class="text-xs px-2 py-1 rounded-md ${color} font-black uppercase tracking-wide">${label} ${sign}${val}</span>`;
        }

        function toggleTrait(index, element) {
            const trait = currentTraits[index];
            if (selectedIndices.has(index)) {
                selectedIndices.delete(index);
                currentPoints += trait.cost;
                element.classList.remove('selected');
                updateStats(trait, false);
            } else {
                if (currentPoints >= trait.cost) {
                    selectedIndices.add(index);
                    currentPoints -= trait.cost;
                    element.classList.add('selected');
                    updateStats(trait, true);
                } else {
                    pointsDisplay.classList.add('animate-pulse', 'bg-red-800', 'text-white');
                    setTimeout(() => pointsDisplay.classList.remove('animate-pulse', 'bg-red-800', 'text-white'), 500);
                }
            }
            updatePointsUI();
            updateStatsUI();
            updateVisuals();
        }

        function updateStats(trait, isAdding) {
            const multiplier = isAdding ? 1 : -1;
            currentStats.atk += trait.stats.atk * multiplier;
            currentStats.def += trait.stats.def * multiplier;
            currentStats.sur += trait.stats.sur * multiplier;
            currentStats.eva += trait.stats.eva * multiplier;
        }

        function updatePointsUI() {
            pointsValue.innerText = currentPoints;
            const used = 30 - currentPoints;
            const pct = (used / 30) * 100;
            document.getElementById('evolution-progress').style.width = `${pct}%`;
        }

        function updateStatsUI() {
            document.getElementById('val-atk').innerText = currentStats.atk;
            document.getElementById('val-def').innerText = currentStats.def;
            document.getElementById('val-sur').innerText = currentStats.sur;
            document.getElementById('val-eva').innerText = currentStats.eva;
            const max = 100; 
            document.getElementById('bar-atk').style.width = Math.min(100, Math.max(0, (currentStats.atk / max) * 100)) + '%';
            document.getElementById('bar-def').style.width = Math.min(100, Math.max(0, (currentStats.def / max) * 100)) + '%';
            document.getElementById('bar-sur').style.width = Math.min(100, Math.max(0, (currentStats.sur / max) * 100)) + '%';
            document.getElementById('bar-eva').style.width = Math.min(100, Math.max(0, (currentStats.eva / max) * 100)) + '%';
        }

        function buildCreature(container, scale = 1, options = {}) {
            container.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = `relative flex items-center justify-center transition-all duration-500`;
            wrapper.style.width = '20rem'; 
            wrapper.style.height = '20rem';
            if (options.className) wrapper.className += ' ' + options.className;
            
            const scaler = document.createElement('div');
            scaler.className = 'relative w-full h-full flex items-center justify-center';
            scaler.style.transform = `scale(${scale})`;
            
            const layers = document.createElement('div');
            layers.className = 'absolute inset-0 flex items-center justify-center pointer-events-none w-full h-full';
            layers.style.zIndex = '5';

            const base = document.createElement('i');
            base.className = `fa-solid ${currentScenario.baseIcon} text-[14rem] text-white drop-shadow-2xl filter transition-all duration-500 relative`;
            base.style.zIndex = '10';
            base.style.color = 'white'; 
            base.style.transform = 'scale(1)'; 

            const accs = document.createElement('div');
            accs.className = 'absolute inset-0 pointer-events-none w-full h-full';
            accs.style.zIndex = '20';

            selectedIndices.forEach(idx => {
                const trait = currentTraits[idx];
                const visuals = Array.isArray(trait.visual) ? trait.visual : [trait.visual];
                
                visuals.forEach(vis => {
                    if (!vis) return;
                    if (vis.type === 'color') {
                        base.style.color = vis.val;
                    } else if (vis.type === 'scale') {
                        base.style.transform = `scale(${vis.val})`; 
                    } else if (vis.type === 'filter') {
                        base.style.filter = `${vis.val} drop-shadow(0 20px 13px rgba(0,0,0,0.5))`;
                    } else if (vis.type === 'attachment') {
                        const acc = document.createElement('i');
                        acc.className = `accessory-icon fa-solid ${vis.icon} ${vis.color}`;
                        acc.style.top = vis.top;
                        acc.style.left = vis.left;
                        acc.style.fontSize = vis.size;
                        acc.style.transform = `translate(-50%, -50%) rotate(${vis.rotate})`;
                        accs.appendChild(acc);
                    } else if (vis.type === 'layer') {
                        const layer = document.createElement('i');
                        layer.className = `absolute inset-0 flex items-center justify-center fa-solid ${currentScenario.baseIcon} ${vis.color}`;
                        layer.style.fontSize = '14rem'; 
                        layer.style.transform = `scale(${vis.scale})`;
                        layer.style.opacity = vis.opacity;
                        if(vis.filter) layer.style.filter = vis.filter;
                        layers.appendChild(layer);
                    }
                });
            });

            scaler.appendChild(layers);
            scaler.appendChild(base);
            scaler.appendChild(accs);
            wrapper.appendChild(scaler);
            container.appendChild(wrapper);
        }

        function updateVisuals() {
            const container = document.getElementById('creature-container');
            buildCreature(container, 1, { className: 'floating' });
        }

        function calculateResults() {
            if (selectedIndices.size === 0) {
                alert("Please select at least one adaptation!");
                return;
            }

            viewLab.classList.add('hidden');
            viewResult.classList.remove('hidden');
            pointsDisplay.classList.add('hidden');

            // 1. Env Context
            document.getElementById('res-env-title').innerText = currentScenario.envTitle;
            document.getElementById('res-env-desc').innerText = currentScenario.envDesc;
            
            const challengesList = document.getElementById('res-env-challenges');
            challengesList.innerHTML = currentScenario.challenges.map(c => `
                <div class="bg-white p-6 rounded-2xl border border-red-100 shadow-sm">
                    <h5 class="font-black text-red-800 text-2xl mb-2">${c.name}${c.critical ? '*' : ''}</h5>
                    <p class="text-lg text-slate-600 leading-normal font-medium">${c.desc}</p>
                </div>
            `).join('');

            // 2. Updated Traits Grid (All Traits with Status)
            const traitsList = document.getElementById('result-traits-list');
            // We use currentTraits (the shuffled one) to show order consistency with selection screen
            traitsList.innerHTML = currentTraits.map((t, idx) => {
                const isSelected = selectedIndices.has(idx);
                const containerClass = isSelected 
                    ? "bg-green-50 border-green-300 ring-2 ring-green-300 shadow-md" 
                    : "bg-slate-50 border-2 border-slate-200 opacity-60 grayscale-[0.5]";
                
                const icon = isSelected 
                    ? `<div class="bg-green-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-sm"><i class="fa-solid fa-check text-lg"></i></div>`
                    : `<div class="bg-slate-200 text-slate-400 w-10 h-10 rounded-full flex items-center justify-center"><i class="fa-solid fa-minus text-lg"></i></div>`;
                
                const label = isSelected 
                    ? `<span class="text-sm font-black uppercase text-green-600 bg-green-100 px-4 py-1 rounded-lg">Active</span>`
                    : `<span class="text-sm font-black uppercase text-slate-500 bg-slate-200 px-4 py-1 rounded-lg">Not Selected</span>`;

                return `
                    <div class="flex items-start gap-5 p-6 rounded-3xl border ${containerClass} transition-all">
                        <div class="mt-1 flex-shrink-0">${icon}</div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-black text-slate-800 text-2xl">${t.name}</h4>
                                ${label}
                            </div>
                            <p class="text-lg text-slate-500 mt-1 leading-normal font-medium">${t.desc}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // Clone Stats
            const statsClone = document.getElementById('stats-bars-container').cloneNode(true);
            const resCloneContainer = document.getElementById('result-stats-clone');
            resCloneContainer.innerHTML = '';
            resCloneContainer.appendChild(statsClone);

            // 3. Survival Analysis Logic
            let passedChallenges = 0;
            let criticalFail = false;
            let failedCount = 0;
            let challengeRowsHTML = '';

            currentScenario.challenges.forEach(challenge => {
                let passed = false;
                let contributors = [];

                if (challenge.requiredTrait) {
                    const required = Array.isArray(challenge.requiredTrait) ? challenge.requiredTrait : [challenge.requiredTrait];
                    
                    // Check against selected indices in currentTraits
                    Array.from(selectedIndices).forEach(idx => {
                        const tName = currentTraits[idx].name;
                        if(required.includes(tName)) {
                            passed = true;
                            contributors.push(tName);
                        }
                    });

                } else {
                    // Check stats
                    let statsPassed = true;
                    challenge.stats.forEach(statKey => {
                        if (currentStats[statKey] < challenge.min) statsPassed = false;
                    });
                    
                    if (statsPassed) {
                        passed = true;
                        Array.from(selectedIndices).forEach(idx => {
                            const t = currentTraits[idx];
                            const helps = challenge.stats.some(k => t.stats[k] > 0);
                            if(helps) contributors.push(t.name);
                        });
                    }
                }

                let contribString = "";
                if (contributors.length > 0) {
                    contribString = contributors.map(c => `<span class="inline-block bg-blue-100 text-blue-900 text-sm px-3 py-1 rounded-lg font-black mr-2 mb-2 shadow-sm border border-blue-200">${c}</span>`).join('');
                } else if (!passed) {
                    contribString = `<span class="text-red-400 text-lg font-bold italic">Missing necessary adaptation</span>`;
                }

                if (passed) {
                    passedChallenges++;
                    challengeRowsHTML += `
                        <tr class="border-b-2 border-slate-700 last:border-0 hover:bg-slate-750 transition-colors">
                            <td class="px-8 py-6 font-bold text-slate-300 text-xl">${challenge.name}</td>
                            <td class="px-8 py-6">
                                <span class="inline-flex items-center gap-3 px-5 py-2 rounded-full text-lg font-black bg-green-900/50 text-green-400 border-2 border-green-800">
                                    <i class="fa-solid fa-check"></i> Overcome
                                </span>
                            </td>
                            <td class="px-8 py-6">${contribString}</td>
                        </tr>`;
                } else {
                    failedCount++;
                    if (challenge.critical) criticalFail = true;
                    challengeRowsHTML += `
                        <tr class="border-b-2 border-slate-700 last:border-0 hover:bg-slate-750 transition-colors">
                            <td class="px-8 py-6 font-bold text-slate-300 text-xl">${challenge.name}</td>
                            <td class="px-8 py-6">
                                <span class="inline-flex items-center gap-3 px-5 py-2 rounded-full text-lg font-black bg-red-900/50 text-red-400 border-2 border-red-800">
                                    <i class="fa-solid fa-xmark"></i> Failed
                                </span>
                            </td>
                            <td class="px-8 py-6">${contribString}</td>
                        </tr>`;
                }
            });

            document.getElementById('result-conditions-table-body').innerHTML = challengeRowsHTML;

            // 4. Verdict Logic
            let tier = "";
            let title = "";
            let message = "";
            let colorClass = "";
            let offspringCount = 0;
            let isDead = false;

            if (criticalFail || failedCount >= 2) {
                tier = "extinct";
                title = "Extinction Event";
                message = criticalFail 
                    ? "Critical failure detected. A key survival requirement was not met."
                    : "Overwhelmed by environmental stressors.";
                colorClass = "text-red-400";
                isDead = true;
                offspringCount = 0;
            } else if (failedCount >= 1) {
                tier = "surviving";
                title = "Survivors";
                message = "You survived, but life is hard. The population is stable.";
                colorClass = "text-yellow-400";
                offspringCount = 2;
            } else {
                tier = "apex";
                title = "Apex Species";
                message = "Perfect adaptation. You dominate the ecosystem.";
                colorClass = "text-green-400";
                offspringCount = 4;
            }

            document.getElementById('result-title').innerText = title;
            document.getElementById('result-title').className = `text-8xl font-black mb-8 ${colorClass} tracking-tight`;
            document.getElementById('result-feedback').innerText = message;
            
            let score = 0;
            if(tier === 'apex') score = 100;
            else if(tier === 'surviving') score = 75;
            else score = 0;
            document.getElementById('final-score-badge').innerText = `Score: ${score}%`;

            // Visuals
            const resultStage = document.getElementById('result-creature-stage');
            resultStage.innerHTML = ''; 

            if (isDead) {
                const deadContainer = document.createElement('div');
                resultStage.appendChild(deadContainer);
                buildCreature(deadContainer, 1, { className: 'dead-creature' });
            } else {
                const scene = document.createElement('div');
                scene.className = 'relative flex items-center justify-center';
                scene.style.width = '240px';
                scene.style.height = '240px';
                resultStage.appendChild(scene);

                const main = document.createElement('div');
                main.className = 'z-10 relative';
                scene.appendChild(main);
                
                let mainAnim = tier === 'apex' ? 'happy-bounce' : 'floating';
                if(tier === 'struggling') mainAnim = ''; 

                buildCreature(main, 1.2, { className: mainAnim });

                const offsets = [
                    { x: -160, y: 70, s: 0.5 },
                    { x: 160, y: 60, s: 0.6 },
                    { x: -200, y: 30, s: 0.4 },
                    { x: 210, y: 90, s: 0.45 }
                ];

                for(let i=0; i<Math.min(offspringCount, offsets.length); i++) {
                    const cfg = offsets[i];
                    const off = document.createElement('div');
                    off.className = 'absolute offspring-container z-0';
                    off.style.transform = `translate(${cfg.x}px, ${cfg.y}px)`; 
                    scene.appendChild(off);
                    buildCreature(off, cfg.s, { className: 'floating' });
                }
            }
        }

        function resetLab() {
            viewResult.classList.add('hidden');
            viewSelection.classList.remove('hidden');
        }

        init();
    </script>
</body>
</html>
